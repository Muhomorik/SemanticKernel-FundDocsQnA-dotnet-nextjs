<mah:MetroWindow
    x:Class="PdfTextExtractor.Wpf.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:PdfTextExtractor.Wpf.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:dxmvvm="http://schemas.devexpress.com/winfx/2008/xaml/mvvm"
    xmlns:mah="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewModels="clr-namespace:PdfTextExtractor.Wpf.ViewModels"
    xmlns:views="clr-namespace:PdfTextExtractor.Wpf.Views"
    Title="{Binding Title}"
    Width="1024"
    Height="700"
    d:DataContext="{d:DesignInstance Type=viewModels:MainViewModel,
                                     IsDesignTimeCreatable=True}"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <Window.Resources>
        <converters:PageStatusToBrushConverter x:Key="StatusToBrushConverter" />
        <converters:StatusBarBrushConverter x:Key="StatusBarBrushConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
    </Window.Resources>

    <!--  Bind Window Loaded event to ViewModel command  -->
    <dxmvvm:Interaction.Behaviors>
        <dxmvvm:EventToCommand Command="{Binding LoadedCommand}" EventName="Loaded" />
    </dxmvvm:Interaction.Behaviors>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  3-Column Layout  -->
        <Grid Grid.Row="0" Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" />
                <ColumnDefinition Width="5" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="5" />
                <ColumnDefinition Width="350" />
            </Grid.ColumnDefinitions>

            <!--  LEFT COLUMN: Page Previews  -->
            <Border
                Grid.Column="0"
                Padding="5"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Grid.Row="0"
                        Margin="5"
                        FontSize="14"
                        FontWeight="Bold"
                        Text="Page Previews" />

                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding PdfDocuments}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Expander
                                        Margin="0,5"
                                        Header="{Binding FileName}"
                                        IsExpanded="{Binding IsExpanded}">
                                        <ItemsControl ItemsSource="{Binding Pages}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Margin="5"
                                                        Padding="5"
                                                        BorderBrush="{Binding Status, Converter={StaticResource StatusToBrushConverter}}"
                                                        BorderThickness="3"
                                                        CornerRadius="5">
                                                        <StackPanel>
                                                            <Image
                                                                Height="120"
                                                                Margin="0,0,0,5"
                                                                Source="{Binding ImagePath, TargetNullValue={x:Null}}"
                                                                Stretch="Uniform"
                                                                Visibility="{Binding ImagePath, Converter={StaticResource NullToVisibilityConverter}}" />
                                                            <StackPanel HorizontalAlignment="Center" Orientation="Horizontal">
                                                                <TextBlock
                                                                    Margin="0,0,5,0"
                                                                    FontSize="16"
                                                                    Text="{Binding StatusIcon}" />
                                                                <TextBlock FontWeight="Bold" Text="{Binding PageNumber, StringFormat='Page {0}'}" />
                                                            </StackPanel>
                                                            <TextBlock
                                                                HorizontalAlignment="Center"
                                                                FontSize="10"
                                                                Foreground="Gray"
                                                                Text="{Binding StatusText}" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Expander>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <GridSplitter
                Grid.Column="1"
                Width="5"
                HorizontalAlignment="Stretch"
                Background="{DynamicResource MahApps.Brushes.Gray5}" />

            <!--  MIDDLE COLUMN: Extracted Text  -->
            <Border
                Grid.Column="2"
                Padding="5"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Grid.Row="0"
                        Margin="5"
                        FontSize="14"
                        FontWeight="Bold"
                        Text="Extracted Text" />

                    <TextBox
                        Grid.Row="1"
                        Margin="5"
                        AcceptsReturn="True"
                        Background="{DynamicResource MahApps.Brushes.Control.Background}"
                        FontFamily="Consolas"
                        FontSize="11"
                        IsReadOnly="True"
                        Text="{Binding ExtractedText, Mode=OneWay}"
                        TextWrapping="Wrap"
                        VerticalScrollBarVisibility="Auto" />
                </Grid>
            </Border>

            <GridSplitter
                Grid.Column="3"
                Width="5"
                HorizontalAlignment="Stretch"
                Background="{DynamicResource MahApps.Brushes.Gray5}" />

            <!--  RIGHT COLUMN: Settings & Controls  -->
            <Border
                Grid.Column="4"
                Padding="10"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock
                            Margin="0,0,0,15"
                            FontSize="16"
                            FontWeight="Bold"
                            Text="PDF Text Extractor" />

                        <!--  Extraction Method Selection  -->
                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Extraction Method:" />
                        <ComboBox
                            Margin="0,0,0,15"
                            ItemsSource="{Binding AvailableMethods}"
                            SelectedItem="{Binding SelectedMethod}"
                            DisplayMemberPath="."
                            ToolTip="Select text extraction method (PdfPig, LM Studio, or OpenAI)" />

                        <Separator Margin="0,10" />

                        <!--  Input Folder  -->
                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Input Folder:" />
                        <DockPanel Margin="0,0,0,10">
                            <Button
                                Width="70"
                                Margin="5,0,0,0"
                                Command="{Binding BrowseInputFolderCommand}"
                                Content="Browse"
                                DockPanel.Dock="Right" />
                            <TextBox IsReadOnly="True" Text="{Binding InputFolderPath, UpdateSourceTrigger=PropertyChanged}" />
                        </DockPanel>

                        <!--  Output Folder  -->
                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Output Folder:" />
                        <DockPanel Margin="0,0,0,10">
                            <Button
                                Width="70"
                                Margin="5,0,0,0"
                                Command="{Binding BrowseOutputFolderCommand}"
                                Content="Browse"
                                DockPanel.Dock="Right" />
                            <TextBox IsReadOnly="True" Text="{Binding OutputFolderPath, UpdateSourceTrigger=PropertyChanged}" />
                        </DockPanel>

                        <!--  Skip If Exists Option  -->
                        <CheckBox
                            Margin="0,5,0,10"
                            IsChecked="{Binding SkipIfExists, UpdateSourceTrigger=PropertyChanged}"
                            ToolTip="Skip extraction for pages whose text files already exist. Enables incremental/resume extraction.">
                            <TextBlock Text="Skip extraction for existing pages" />
                        </CheckBox>

                        <Separator Margin="0,10" />

                        <!--  PdfPig Configuration Panel (visible only when PdfPig is selected)  -->
                        <views:PdfPigConfigView
                            DataContext="{Binding PdfPigConfig}"
                            Visibility="{Binding DataContext.IsPdfPigSelected, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}, Converter={StaticResource BoolToVisibilityConverter}}" />

                        <!--  LM Studio Configuration Panel (visible only when LM Studio is selected)  -->
                        <views:LMStudioConfigView
                            DataContext="{Binding LMStudioConfig}"
                            Visibility="{Binding DataContext.IsLMStudioSelected, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}, Converter={StaticResource BoolToVisibilityConverter}}" />

                        <!--  OpenAI Configuration Panel (visible only when OpenAI is selected)  -->
                        <views:OpenAIConfigView
                            DataContext="{Binding OpenAIConfig}"
                            Visibility="{Binding DataContext.IsOpenAISelected, RelativeSource={RelativeSource AncestorType=mah:MetroWindow}, Converter={StaticResource BoolToVisibilityConverter}}" />

                        <Separator Margin="0,10" />

                        <!--  Actions  -->
                        <Button
                            Height="40"
                            Margin="0,10,0,5"
                            Command="{Binding StartExtractionCommand}"
                            Content="Start Extraction"
                            FontSize="14"
                            FontWeight="Bold"
                            Style="{DynamicResource MahApps.Styles.Button.Square.Accent}" />

                        <Button
                            Height="35"
                            Margin="0,0,0,15"
                            Command="{Binding CancelExtractionCommand}"
                            Content="Cancel"
                            Visibility="{Binding IsExtracting, Converter={StaticResource BoolToVisibilityConverter}}" />

                        <!--  Progress  -->
                        <mah:MetroProgressBar
                            Height="20"
                            Margin="0,5"
                            Maximum="100"
                            Visibility="{Binding IsExtracting, Converter={StaticResource BoolToVisibilityConverter}}"
                            Value="{Binding OverallProgress}" />
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!--  Status Bar  -->
        <Border
            Grid.Row="1"
            Padding="10,5"
            Background="{Binding Status, Converter={StaticResource StatusBarBrushConverter}}"
            BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
            BorderThickness="0,1,0,0">
            <TextBlock
                VerticalAlignment="Center"
                Foreground="White"
                Text="{Binding Status}" />
        </Border>
    </Grid>
</mah:MetroWindow>
