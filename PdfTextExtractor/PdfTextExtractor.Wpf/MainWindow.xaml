<mah:MetroWindow
    x:Class="PdfTextExtractor.Wpf.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:PdfTextExtractor.Wpf.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:dxmvvm="http://schemas.devexpress.com/winfx/2008/xaml/mvvm"
    xmlns:mah="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewModels="clr-namespace:PdfTextExtractor.Wpf.ViewModels"
    Title="{Binding Title}"
    Width="1024"
    Height="700"
    d:DataContext="{d:DesignInstance Type=viewModels:MainViewModel,
                                     IsDesignTimeCreatable=True}"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <Window.Resources>
        <converters:PageStatusToBrushConverter x:Key="StatusToBrushConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
    </Window.Resources>

    <!--  Bind Window Loaded event to ViewModel command  -->
    <dxmvvm:Interaction.Behaviors>
        <dxmvvm:EventToCommand Command="{Binding LoadedCommand}" EventName="Loaded" />
    </dxmvvm:Interaction.Behaviors>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  3-Column Layout  -->
        <Grid Grid.Row="0" Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250" />
                <ColumnDefinition Width="5" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="5" />
                <ColumnDefinition Width="350" />
            </Grid.ColumnDefinitions>

            <!--  LEFT COLUMN: Page Previews  -->
            <Border
                Grid.Column="0"
                Padding="5"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Grid.Row="0"
                        Margin="5"
                        FontSize="14"
                        FontWeight="Bold"
                        Text="Page Previews" />

                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding PdfDocuments}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Expander
                                        Margin="0,5"
                                        Header="{Binding FileName}"
                                        IsExpanded="{Binding IsExpanded}">
                                        <ItemsControl ItemsSource="{Binding Pages}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Margin="5"
                                                        Padding="5"
                                                        BorderBrush="{Binding Status, Converter={StaticResource StatusToBrushConverter}}"
                                                        BorderThickness="3"
                                                        CornerRadius="5">
                                                        <StackPanel>
                                                            <Image
                                                                Height="120"
                                                                Margin="0,0,0,5"
                                                                Source="{Binding ImagePath, TargetNullValue={x:Null}}"
                                                                Stretch="Uniform"
                                                                Visibility="{Binding ImagePath, Converter={StaticResource NullToVisibilityConverter}}" />
                                                            <StackPanel HorizontalAlignment="Center" Orientation="Horizontal">
                                                                <TextBlock
                                                                    Margin="0,0,5,0"
                                                                    FontSize="16"
                                                                    Text="{Binding StatusIcon}" />
                                                                <TextBlock FontWeight="Bold" Text="{Binding PageNumber, StringFormat='Page {0}'}" />
                                                            </StackPanel>
                                                            <TextBlock
                                                                HorizontalAlignment="Center"
                                                                FontSize="10"
                                                                Foreground="Gray"
                                                                Text="{Binding StatusText}" />
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Expander>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <GridSplitter
                Grid.Column="1"
                Width="5"
                HorizontalAlignment="Stretch"
                Background="{DynamicResource MahApps.Brushes.Gray5}" />

            <!--  MIDDLE COLUMN: Extracted Text  -->
            <Border
                Grid.Column="2"
                Padding="5"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Grid.Row="0"
                        Margin="5"
                        FontSize="14"
                        FontWeight="Bold"
                        Text="Extracted Text" />

                    <TextBox
                        Grid.Row="1"
                        Margin="5"
                        AcceptsReturn="True"
                        Background="{DynamicResource MahApps.Brushes.Control.Background}"
                        FontFamily="Consolas"
                        FontSize="11"
                        IsReadOnly="True"
                        Text="{Binding ExtractedText, Mode=OneWay}"
                        TextWrapping="Wrap"
                        VerticalScrollBarVisibility="Auto" />
                </Grid>
            </Border>

            <GridSplitter
                Grid.Column="3"
                Width="5"
                HorizontalAlignment="Stretch"
                Background="{DynamicResource MahApps.Brushes.Gray5}" />

            <!--  RIGHT COLUMN: Settings & Controls  -->
            <Border
                Grid.Column="4"
                Padding="10"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock
                            Margin="0,0,0,15"
                            FontSize="16"
                            FontWeight="Bold"
                            Text="PDF Text Extractor" />

                        <!--  Extraction Method Selection  -->
                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Extraction Method:" />
                        <ComboBox
                            Margin="0,0,0,15"
                            ItemsSource="{Binding AvailableMethods}"
                            SelectedItem="{Binding SelectedMethod}"
                            DisplayMemberPath="."
                            ToolTip="Select text extraction method (LM Studio or OpenAI)" />

                        <Separator Margin="0,10" />

                        <!--  Input Folder  -->
                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Input Folder:" />
                        <DockPanel Margin="0,0,0,10">
                            <Button
                                Width="70"
                                Margin="5,0,0,0"
                                Command="{Binding BrowseInputFolderCommand}"
                                Content="Browse"
                                DockPanel.Dock="Right" />
                            <TextBox IsReadOnly="True" Text="{Binding InputFolderPath, UpdateSourceTrigger=PropertyChanged}" />
                        </DockPanel>

                        <!--  Output Folder  -->
                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Output Folder:" />
                        <DockPanel Margin="0,0,0,10">
                            <Button
                                Width="70"
                                Margin="5,0,0,0"
                                Command="{Binding BrowseOutputFolderCommand}"
                                Content="Browse"
                                DockPanel.Dock="Right" />
                            <TextBox IsReadOnly="True" Text="{Binding OutputFolderPath, UpdateSourceTrigger=PropertyChanged}" />
                        </DockPanel>

                        <Separator Margin="0,10" />

                        <!--  Optimal Settings Info Panel  -->
                        <Expander
                            Margin="0,10,0,10"
                            IsExpanded="True"
                            Header="✅ Tested Configuration (GTX 1060 6GB)">
                            <Border
                                Margin="5"
                                Padding="10"
                                Background="{DynamicResource MahApps.Brushes.Gray10}"
                                CornerRadius="5">
                                <StackPanel>
                                    <TextBlock
                                        FontSize="12"
                                        FontWeight="Bold"
                                        Text="Recommended LM Studio Settings:" />
                                    <TextBlock
                                        Margin="5,5,0,2"
                                        FontSize="11"
                                        Text="• GPU Offload: 12 layers" />
                                    <TextBlock
                                        Margin="5,0,0,2"
                                        FontSize="11"
                                        Text="• Context Length: 4096 tokens" />
                                    <TextBlock
                                        Margin="5,0,0,2"
                                        FontSize="11"
                                        Text="• Model: qwen/qwen2.5-vl-7b" />

                                    <Separator Margin="0,8" />

                                    <TextBlock
                                        Margin="0,5,0,5"
                                        FontSize="12"
                                        FontWeight="Bold"
                                        Text="Performance (per page):" />
                                    <TextBlock
                                        Margin="5,0,0,2"
                                        FontSize="11"
                                        Text="• DPI 150: ~2 min (fastest)" />
                                    <TextBlock
                                        Margin="5,0,0,2"
                                        FontSize="11"
                                        Text="• DPI 200: ~2 min (recommended)" />
                                    <TextBlock
                                        Margin="5,0,0,2"
                                        FontSize="11"
                                        Text="• DPI 300: ~3 min (best quality)" />
                                </StackPanel>
                            </Border>
                        </Expander>

                        <!--  LM Studio Configuration Panel (visible only when LM Studio is selected)  -->
                        <StackPanel Visibility="{Binding IsLMStudioSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock
                                Margin="0,10,0,10"
                                FontSize="14"
                                FontWeight="Bold"
                                Text="LM Studio Configuration" />

                            <TextBlock
                                Margin="0,5,0,3"
                                FontWeight="SemiBold"
                                Text="LM Studio URL:" />
                            <TextBox Margin="0,0,0,10" Text="{Binding LMStudioUrl, UpdateSourceTrigger=PropertyChanged}" />

                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Vision Model Name:" />
                        <TextBox Margin="0,0,0,10" Text="{Binding VisionModelName, UpdateSourceTrigger=PropertyChanged}" />

                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Rasterization DPI:" />
                        <DockPanel Margin="0,0,0,5">
                            <StackPanel
                                DockPanel.Dock="Right"
                                Orientation="Horizontal">
                                <Button
                                    Width="40"
                                    Margin="2,0"
                                    Command="{Binding SetDpiCommand}"
                                    CommandParameter="150"
                                    Content="150"
                                    ToolTip="Fast - 2 min/page" />
                                <Button
                                    Width="40"
                                    Margin="2,0"
                                    Command="{Binding SetDpiCommand}"
                                    CommandParameter="200"
                                    Content="200"
                                    Style="{DynamicResource MahApps.Styles.Button.Square.Accent}"
                                    ToolTip="Recommended - 2 min/page" />
                                <Button
                                    Width="40"
                                    Margin="2,0"
                                    Command="{Binding SetDpiCommand}"
                                    CommandParameter="300"
                                    Content="300"
                                    ToolTip="Best quality - 3 min/page" />
                            </StackPanel>
                            <mah:NumericUpDown
                                Interval="50"
                                Maximum="600"
                                Minimum="72"
                                Value="{Binding Dpi}" />
                        </DockPanel>

                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Chunk Size (characters):" />
                        <mah:NumericUpDown
                            Margin="0,0,0,15"
                            Interval="100"
                            Maximum="5000"
                            Minimum="100"
                            Value="{Binding ChunkSize}" />

                        <TextBlock
                            Margin="0,5,0,3"
                            FontWeight="SemiBold"
                            Text="Max Tokens (vision model output):" />
                        <DockPanel Margin="0,0,0,15">
                            <StackPanel
                                DockPanel.Dock="Right"
                                Orientation="Horizontal">
                                <Button
                                    Width="50"
                                    Margin="2,0"
                                    Command="{Binding SetMaxTokensCommand}"
                                    CommandParameter="500"
                                    Content="500"
                                    ToolTip="Partial pages - fast" />
                                <Button
                                    Width="50"
                                    Margin="2,0"
                                    Command="{Binding SetMaxTokensCommand}"
                                    CommandParameter="2000"
                                    Content="2000"
                                    Style="{DynamicResource MahApps.Styles.Button.Square.Accent}"
                                    ToolTip="Full pages - recommended" />
                                <Button
                                    Width="50"
                                    Margin="2,0"
                                    Command="{Binding SetMaxTokensCommand}"
                                    CommandParameter="4000"
                                    Content="4000"
                                    ToolTip="Very long pages - may fail" />
                            </StackPanel>
                            <mah:NumericUpDown
                                Interval="100"
                                Maximum="8000"
                                Minimum="100"
                                Value="{Binding MaxTokens}" />
                        </DockPanel>
                        </StackPanel>

                        <!--  OpenAI Configuration Panel (visible only when OpenAI is selected)  -->
                        <StackPanel Visibility="{Binding IsOpenAISelected, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock
                                Margin="0,10,0,10"
                                FontSize="14"
                                FontWeight="Bold"
                                Text="OpenAI Configuration" />

                            <TextBlock
                                Margin="0,5,0,3"
                                FontWeight="SemiBold"
                                Text="OpenAI API Key:" />
                            <PasswordBox
                                x:Name="OpenAIApiKeyBox"
                                Margin="0,0,0,10"
                                PasswordChanged="OnOpenAIApiKeyChanged"
                                ToolTip="Enter your OpenAI API key (sk-...)" />

                            <TextBlock
                                Margin="0,5,0,3"
                                FontWeight="SemiBold"
                                Text="Vision Model Name:" />
                            <TextBox
                                Margin="0,0,0,10"
                                Text="{Binding OpenAIModelName, UpdateSourceTrigger=PropertyChanged}"
                                ToolTip="Default: gpt-4o" />

                            <TextBlock
                                Margin="0,5,0,3"
                                FontWeight="SemiBold"
                                Text="Rasterization DPI:" />
                            <DockPanel Margin="0,0,0,5">
                                <StackPanel
                                    DockPanel.Dock="Right"
                                    Orientation="Horizontal">
                                    <Button
                                        Width="40"
                                        Margin="2,0"
                                        Command="{Binding SetOpenAIDpiCommand}"
                                        CommandParameter="150"
                                        Content="150"
                                        Style="{DynamicResource MahApps.Styles.Button.Square.Accent}"
                                        ToolTip="Recommended - balance quality/cost" />
                                    <Button
                                        Width="40"
                                        Margin="2,0"
                                        Command="{Binding SetOpenAIDpiCommand}"
                                        CommandParameter="200"
                                        Content="200"
                                        ToolTip="Higher quality" />
                                    <Button
                                        Width="40"
                                        Margin="2,0"
                                        Command="{Binding SetOpenAIDpiCommand}"
                                        CommandParameter="300"
                                        Content="300"
                                        ToolTip="Best quality - higher cost" />
                                </StackPanel>
                                <mah:NumericUpDown
                                    Interval="50"
                                    Maximum="600"
                                    Minimum="72"
                                    Value="{Binding OpenAIDpi}" />
                            </DockPanel>

                            <TextBlock
                                Margin="0,5,0,3"
                                FontWeight="SemiBold"
                                Text="Max Tokens (vision model output):" />
                            <DockPanel Margin="0,0,0,15">
                                <StackPanel
                                    DockPanel.Dock="Right"
                                    Orientation="Horizontal">
                                    <Button
                                        Width="50"
                                        Margin="2,0"
                                        Command="{Binding SetOpenAIMaxTokensCommand}"
                                        CommandParameter="1000"
                                        Content="1000"
                                        ToolTip="Standard pages" />
                                    <Button
                                        Width="50"
                                        Margin="2,0"
                                        Command="{Binding SetOpenAIMaxTokensCommand}"
                                        CommandParameter="2000"
                                        Content="2000"
                                        Style="{DynamicResource MahApps.Styles.Button.Square.Accent}"
                                        ToolTip="Full pages - recommended" />
                                    <Button
                                        Width="50"
                                        Margin="2,0"
                                        Command="{Binding SetOpenAIMaxTokensCommand}"
                                        CommandParameter="4000"
                                        Content="4000"
                                        ToolTip="Very long pages" />
                                </StackPanel>
                                <mah:NumericUpDown
                                    Interval="100"
                                    Maximum="16000"
                                    Minimum="100"
                                    Value="{Binding OpenAIMaxTokens}" />
                            </DockPanel>

                            <Border
                                Margin="0,10"
                                Padding="10"
                                Background="{DynamicResource MahApps.Brushes.Gray10}"
                                CornerRadius="5">
                                <StackPanel>
                                    <TextBlock
                                        FontSize="11"
                                        FontWeight="Bold"
                                        Text="💰 Cost Estimation (gpt-4o):" />
                                    <TextBlock
                                        Margin="5,5,0,2"
                                        FontSize="10"
                                        Text="• High detail: ~$0.003 per page" />
                                    <TextBlock
                                        Margin="5,0,0,2"
                                        FontSize="10"
                                        Text="• Low detail: ~$0.0002 per page" />
                                    <TextBlock
                                        Margin="5,0,0,2"
                                        FontSize="10"
                                        Text="• 10 pages ≈ $0.03 (high) / $0.002 (low)" />
                                    <TextBlock
                                        Margin="5,0,0,0"
                                        FontSize="10"
                                        Foreground="Orange"
                                        Text="⚠️ Requires API key with billing enabled" />
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <Separator Margin="0,10" />

                        <!--  Actions  -->
                        <Button
                            Height="40"
                            Margin="0,10,0,5"
                            Command="{Binding StartExtractionCommand}"
                            Content="Start Extraction"
                            FontSize="14"
                            FontWeight="Bold"
                            Style="{DynamicResource MahApps.Styles.Button.Square.Accent}" />

                        <Button
                            Height="35"
                            Margin="0,0,0,15"
                            Command="{Binding CancelExtractionCommand}"
                            Content="Cancel"
                            Visibility="{Binding IsExtracting, Converter={StaticResource BoolToVisibilityConverter}}" />

                        <!--  Progress  -->
                        <mah:MetroProgressBar
                            Height="20"
                            Margin="0,5"
                            Maximum="100"
                            Visibility="{Binding IsExtracting, Converter={StaticResource BoolToVisibilityConverter}}"
                            Value="{Binding OverallProgress}" />
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!--  Status Bar  -->
        <Border
            Grid.Row="1"
            Padding="10,5"
            Background="{DynamicResource MahApps.Brushes.Control.Background}"
            BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
            BorderThickness="0,1,0,0">
            <TextBlock VerticalAlignment="Center" Text="{Binding Status}" />
        </Border>
    </Grid>
</mah:MetroWindow>
