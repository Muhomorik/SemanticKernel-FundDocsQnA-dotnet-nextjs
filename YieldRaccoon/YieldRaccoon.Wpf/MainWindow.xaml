<mah:MetroWindow
    x:Class="YieldRaccoon.Wpf.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:behaviors="clr-namespace:YieldRaccoon.Wpf.Behaviors"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:dxmvvm="http://schemas.devexpress.com/winfx/2008/xaml/mvvm"
    xmlns:local="clr-namespace:YieldRaccoon.Wpf"
    xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
    Title="{Binding Title}"
    Width="1768"
    Height="1128"
    TitleCharacterCasing="Normal"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <!--  Title bar commands (right side)  -->
    <mah:MetroWindow.RightWindowCommands>
        <mah:WindowCommands>
            <Button Command="{Binding OpenSettingsCommand}" ToolTip="Settings">
                <StackPanel Orientation="Horizontal">
                    <TextBlock
                        FontFamily="Segoe Fluent Icons"
                        FontSize="14"
                        Text="&#xE713;" />
                    <TextBlock Margin="6,0,0,0" Text="Settings" />
                </StackPanel>
            </Button>
        </mah:WindowCommands>
    </mah:MetroWindow.RightWindowCommands>

    <!--  Bind Window Loaded event to ViewModel command  -->
    <dxmvvm:Interaction.Behaviors>
        <dxmvvm:EventToCommand Command="{Binding LoadedCommand}" EventName="Loaded" />
    </dxmvvm:Interaction.Behaviors>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Main content area with 3 columns  -->
        <Grid Grid.Row="0" Margin="10">
            <Grid.ColumnDefinitions>
                <!--  Left column (300px)  -->
                <ColumnDefinition Width="300" />
                <!--  Splitter  -->
                <ColumnDefinition Width="Auto" />
                <!--  Middle column (browser)  -->
                <ColumnDefinition Width="*" />
                <!--  Splitter  -->
                <ColumnDefinition Width="Auto" />
                <!--  Right column (300px)  -->
                <ColumnDefinition Width="300" />
            </Grid.ColumnDefinitions>

            <!--  Left panel  -->
            <Border
                Grid.Column="0"
                Background="{DynamicResource MahApps.Brushes.Gray10}"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1"
                CornerRadius="4">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Header  -->
                    <StackPanel Grid.Row="0">
                        <TextBlock
                            FontSize="16"
                            FontWeight="Bold"
                            Text="Extracted Funds" />
                        <TextBlock
                            Margin="0,5,0,0"
                            FontSize="12"
                            Foreground="{DynamicResource MahApps.Brushes.Gray1}">
                            <Run Text="Showing: " />
                            <Run FontWeight="Bold" Text="{Binding FundCount, Mode=OneWay}" />
                            <Run Text=" of " />
                            <Run FontWeight="Bold" Text="{Binding TotalFundCount, Mode=OneWay}" />
                            <Run Text=" funds" />
                        </TextBlock>
                    </StackPanel>

                    <!--  Fund List  -->
                    <ListBox
                        Grid.Row="1"
                        Margin="0,10,0,0"
                        Background="Transparent"
                        BorderThickness="0"
                        ItemsSource="{Binding Funds}"
                        behaviors:ListBoxAutoScrollBehavior.AutoScrollToEnd="True"
                        behaviors:ListBoxAutoScrollBehavior.AnimationDuration="0:0:3">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="0,5,0,10">
                                    <!--  Fund Name  -->
                                    <TextBlock
                                        FontWeight="SemiBold"
                                        Text="{Binding Name}"
                                        TextWrapping="Wrap" />

                                    <!--  ISIN  -->
                                    <TextBlock
                                        FontSize="11"
                                        Foreground="{DynamicResource MahApps.Brushes.Gray2}"
                                        Text="{Binding Isin}" />

                                    <!--  NAV, Currency, and Date  -->
                                    <StackPanel Margin="0,3,0,0" Orientation="Horizontal">
                                        <TextBlock
                                            FontSize="11"
                                            FontWeight="Medium"
                                            Foreground="{DynamicResource MahApps.Brushes.Accent}"
                                            Text="NAV: " />
                                        <TextBlock
                                            FontSize="11"
                                            FontWeight="Medium"
                                            Foreground="{DynamicResource MahApps.Brushes.Accent}"
                                            Text="{Binding Nav, StringFormat={}{0:N2}}" />
                                        <TextBlock
                                            Margin="3,0,0,0"
                                            FontSize="11"
                                            Foreground="{DynamicResource MahApps.Brushes.Gray2}"
                                            Text="{Binding CurrencyCode}" />
                                        <TextBlock
                                            Margin="6,0,0,0"
                                            FontSize="10"
                                            Foreground="{DynamicResource MahApps.Brushes.Gray3}"
                                            Text="•" />
                                        <TextBlock
                                            x:Name="NavDateText"
                                            Margin="6,0,0,0"
                                            FontSize="10"
                                            Foreground="{DynamicResource MahApps.Brushes.Gray3}"
                                            Text="{Binding NavDate, StringFormat={}{0:yyyy-MM-dd}}" />
                                    </StackPanel>

                                    <!--  Number of Owners  -->
                                    <StackPanel Margin="0,2,0,0" Orientation="Horizontal">
                                        <TextBlock
                                            FontSize="10"
                                            Foreground="{DynamicResource MahApps.Brushes.Gray3}"
                                            Text="Owners: " />
                                        <TextBlock
                                            FontSize="10"
                                            Foreground="{DynamicResource MahApps.Brushes.Gray3}"
                                            Text="{Binding NumberOfOwners, StringFormat={}{0:N0}}" />
                                    </StackPanel>
                                </StackPanel>
                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding IsNavDateToday}" Value="True">
                                        <Setter TargetName="NavDateText" Property="Foreground" Value="#2ECC71" />
                                        <Setter TargetName="NavDateText" Property="FontWeight" Value="SemiBold" />
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <!--  Left splitter  -->
            <GridSplitter
                Grid.Column="1"
                Width="5"
                HorizontalAlignment="Center"
                Background="{DynamicResource MahApps.Brushes.Gray8}" />

            <!--  Middle panel - Browser  -->
            <Border
                Grid.Column="2"
                Background="{DynamicResource MahApps.Brushes.ThemeBackground}"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1"
                CornerRadius="4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Browser toolbar  -->
                    <Border
                        Grid.Row="0"
                        Padding="10,5"
                        Background="{DynamicResource MahApps.Brushes.Gray9}"
                        BorderBrush="{DynamicResource MahApps.Brushes.Gray7}"
                        BorderThickness="0,0,0,1">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!--  Reload button  -->
                            <Button
                                Grid.Column="0"
                                Width="80"
                                Command="{Binding ReloadBrowserCommand}"
                                Content="Reload"
                                Style="{StaticResource MahApps.Styles.Button.Flat}" />

                            <!--  URL display  -->
                            <TextBox
                                Grid.Column="1"
                                Margin="10,0,0,0"
                                VerticalAlignment="Center"
                                IsReadOnly="True"
                                Text="{Binding BrowserUrl, Mode=OneWay}" />

                            <!--  Streaming mode toggle  -->
                            <mah:ToggleSwitch
                                Grid.Column="2"
                                Margin="10,0,0,0"
                                IsOn="{Binding IsStreamingMode}"
                                OffContent="Normal"
                                OnContent="Streaming"
                                ToolTip="Apply privacy filter to browser content for streaming" />
                        </Grid>
                    </Border>

                    <!--  WebView2 Browser with streaming mode privacy overlay  -->
                    <Grid x:Name="BrowserContainer" Grid.Row="1">
                        <!--  Browser (always visible - overlay covers when streaming)  -->
                        <wv2:WebView2
                            x:Name="Browser"
                            Source="{Binding BrowserUrl, Mode=OneWay}" />

                        <!--  Charcoal-filtered screenshot overlay (covers browser when streaming)  -->
                        <Grid Background="Black" Visibility="{Binding IsStreamingMode, Converter={dxmvvm:BooleanToVisibilityConverter}}">
                            <Image
                                RenderOptions.BitmapScalingMode="NearestNeighbor"
                                Source="{Binding StreamingScreenshot}"
                                Stretch="Fill" />

                            <!--  Streaming mode indicator overlay  -->
                            <Border Background="#44000000">
                                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <TextBlock
                                        FontSize="48"
                                        FontWeight="Bold"
                                        Foreground="#FF4444"
                                        Text="🔴 STREAMING" />
                                    <TextBlock
                                        Margin="0,15,0,0"
                                        HorizontalAlignment="Center"
                                        FontSize="16"
                                        Foreground="White"
                                        Text="Browser content filtered for privacy" />
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Grid>
                </Grid>
            </Border>

            <!--  Right splitter  -->
            <GridSplitter
                Grid.Column="3"
                Width="5"
                HorizontalAlignment="Center"
                Background="{DynamicResource MahApps.Brushes.Gray8}" />

            <!--  Right panel - Control Panel  -->
            <Border
                Grid.Column="4"
                Background="{DynamicResource MahApps.Brushes.Gray10}"
                BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                BorderThickness="1"
                CornerRadius="4">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <!--  Header  -->
                        <RowDefinition Height="Auto" />
                        <!--  Manual Control  -->
                        <RowDefinition Height="Auto" />
                        <!--  Session Control  -->
                        <RowDefinition Height="Auto" />
                        <!--  Session Progress  -->
                        <RowDefinition Height="Auto" />
                        <!--  Scheduled Batches (fills remaining space)  -->
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Header  -->
                    <TextBlock
                        Grid.Row="0"
                        FontSize="16"
                        FontWeight="Bold"
                        Text="Crawl Control" />

                    <!--  Manual Control Section  -->
                    <StackPanel Grid.Row="1" Margin="0,15,0,0">
                        <TextBlock
                            Margin="0,0,0,5"
                            FontSize="12"
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource MahApps.Brushes.Gray2}"
                            Text="MANUAL CONTROL" />
                        <Button
                            Command="{Binding LoadNextBatchCommand}"
                            Content="Load Next Batch"
                            Style="{StaticResource MahApps.Styles.Button.Square}"
                            ToolTip="Load next batch only (click 'Visa fler' once)" />
                    </StackPanel>

                    <!--  Session Control Section  -->
                    <StackPanel Grid.Row="2" Margin="0,20,0,0">
                        <TextBlock
                            Margin="0,0,0,5"
                            FontSize="12"
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource MahApps.Brushes.Gray2}"
                            Text="SESSION CONTROL" />

                        <mah:ToggleSwitch
                            Margin="0,5,0,0"
                            IsOn="{Binding IsAutoStartEnabled}"
                            OffContent="Auto-start disabled"
                            OnContent="Auto-start enabled" />

                        <Grid Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="5" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <Button
                                Grid.Column="0"
                                Command="{Binding StartSessionCommand}"
                                Content="Start Crawling"
                                Style="{StaticResource MahApps.Styles.Button.Square.Accent}" />

                            <Button
                                Grid.Column="2"
                                Command="{Binding StopSessionCommand}"
                                Content="Stop"
                                Style="{StaticResource MahApps.Styles.Button.Square}" />
                        </Grid>
                    </StackPanel>

                    <!--  Progress Display (visible when session is active)  -->
                    <StackPanel
                        Grid.Row="3"
                        Margin="0,20,0,0"
                        Visibility="{Binding IsSessionActive, Converter={dxmvvm:BooleanToVisibilityConverter}}">

                        <TextBlock
                            FontSize="12"
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource MahApps.Brushes.Gray2}"
                            Text="SESSION PROGRESS" />

                        <!--  Status message  -->
                        <TextBlock
                            Margin="0,10,0,0"
                            FontWeight="Medium"
                            Text="{Binding SessionStatusMessage}"
                            TextWrapping="Wrap" />

                        <!--  Delay countdown (visible during delay)  -->
                        <StackPanel
                            Margin="0,10,0,0"
                            Orientation="Horizontal"
                            Visibility="{Binding IsDelayInProgress, Converter={dxmvvm:BooleanToVisibilityConverter}}">
                            <mah:ProgressRing
                                Width="20"
                                Height="20"
                                IsActive="True" />
                            <TextBlock
                                Margin="10,0,0,0"
                                VerticalAlignment="Center"
                                FontSize="14"
                                FontWeight="Bold"
                                Foreground="{DynamicResource MahApps.Brushes.Accent}"
                                Text="{Binding DelayCountdown, StringFormat={}{0}s}" />
                        </StackPanel>

                        <!--  Batch progress  -->
                        <TextBlock Margin="0,10,0,0" FontSize="12">
                            <Run Text="Batch: " />
                            <Run FontWeight="Bold" Text="{Binding CurrentBatchNumber, Mode=OneWay}" />
                            <Run Text=" / " />
                            <Run Text="{Binding EstimatedBatchCount, Mode=OneWay}" />
                        </TextBlock>

                        <!--  Fund progress  -->
                        <TextBlock Margin="0,5,0,0" FontSize="12">
                            <Run Text="Funds: " />
                            <Run FontWeight="Bold" Text="{Binding FundCount, Mode=OneWay}" />
                            <Run Text=" / " />
                            <Run Text="{Binding TotalFundCount, Mode=OneWay}" />
                        </TextBlock>

                        <!--  Time remaining  -->
                        <TextBlock Margin="0,5,0,0" FontSize="12">
                            <Run Text="Time remaining: " />
                            <Run FontWeight="Bold" Text="{Binding EstimatedTimeRemaining, Mode=OneWay, StringFormat=mm\\:ss}" />
                        </TextBlock>

                        <!--  Progress bar  -->
                        <mah:MetroProgressBar
                            Margin="0,10,0,0"
                            Maximum="{Binding TotalFundCount}"
                            Value="{Binding FundCount}" />
                    </StackPanel>

                    <!--  Scheduled Batches Section (visible when session is active, fills remaining space)  -->
                    <Grid
                        Grid.Row="4"
                        Margin="0,20,0,0"
                        Visibility="{Binding IsSessionActive, Converter={dxmvvm:BooleanToVisibilityConverter}}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <TextBlock
                            Grid.Row="0"
                            FontSize="12"
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource MahApps.Brushes.Gray2}"
                            Text="SCHEDULED BATCHES" />

                        <ListBox
                            Grid.Row="1"
                            Margin="0,10,0,0"
                            Background="Transparent"
                            BorderThickness="0"
                            ItemsSource="{Binding ScheduledBatches}"
                            ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                            VirtualizingPanel.IsVirtualizing="True"
                            VirtualizingPanel.VirtualizationMode="Recycling">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid
                                        x:Name="RowGrid"
                                        Margin="0,2"
                                        behaviors:CompletionFlashBehavior.FlashColor="LightGreen"
                                        behaviors:CompletionFlashBehavior.FlashDuration="0:0:2"
                                        behaviors:CompletionFlashBehavior.FlashHoldDuration="0:0:5"
                                        behaviors:CompletionFlashBehavior.Status="{Binding Status}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="40" />
                                            <ColumnDefinition Width="60" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <!--  Batch number  -->
                                        <TextBlock
                                            Grid.Column="0"
                                            FontSize="11"
                                            FontWeight="SemiBold"
                                            Text="{Binding BatchNumber.Value, StringFormat=#{0}}" />

                                        <!--  Scheduled time  -->
                                        <TextBlock
                                            Grid.Column="1"
                                            FontSize="11"
                                            Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                                            Text="{Binding ScheduledAt, StringFormat=HH:mm:ss}" />

                                        <!--  Status indicator using Segoe Fluent Icons  -->
                                        <TextBlock
                                            x:Name="StatusIndicator"
                                            Grid.Column="2"
                                            HorizontalAlignment="Right"
                                            FontFamily="Segoe Fluent Icons"
                                            FontSize="12" />
                                    </Grid>
                                    <DataTemplate.Triggers>
                                        <DataTrigger Binding="{Binding Status}" Value="Completed">
                                            <!--  Checkmark icon (E73E) - Green for success  -->
                                            <Setter TargetName="StatusIndicator" Property="Text" Value="&#xE73E;" />
                                            <Setter TargetName="StatusIndicator" Property="Foreground" Value="#2ECC71" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="InProgress">
                                            <!--  Sync icon (E895) - Accent/Blue for active  -->
                                            <Setter TargetName="StatusIndicator" Property="Text" Value="&#xE895;" />
                                            <Setter TargetName="StatusIndicator" Property="Foreground" Value="{DynamicResource MahApps.Brushes.Accent}" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Pending">
                                            <!--  Clock icon (E823) - Orange/Amber for waiting  -->
                                            <Setter TargetName="StatusIndicator" Property="Text" Value="&#xE823;" />
                                            <Setter TargetName="StatusIndicator" Property="Foreground" Value="#F39C12" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Failed">
                                            <!--  Error icon (E783) - Red for error  -->
                                            <Setter TargetName="StatusIndicator" Property="Text" Value="&#xE783;" />
                                            <Setter TargetName="StatusIndicator" Property="Foreground" Value="#E74C3C" />
                                        </DataTrigger>
                                    </DataTemplate.Triggers>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <!--  Status bar  -->
        <StatusBar Grid.Row="1">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" />
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,10,0"
                        VerticalAlignment="Center"
                        Text="{Binding IsLoading, StringFormat='Loading: {0}'}" />
                    <Button
                        Command="{Binding RefreshCommand}"
                        Content="Refresh"
                        Style="{StaticResource MahApps.Styles.Button.Flat}" />
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</mah:MetroWindow>
